<div *ngIf="openerUrl" class="bg-warning-subtle border border-black text-center">Notice: This page is sending changes
  back to the page that opened it, <span class="text-primary">{{ openerUrl }}</span></div>
<div class="page-defaults container-fluid bg-white shadow">
  <lfb-header id="fixedTop"></lfb-header>
  <div id="resizableMiddle">
    <nav class="navbar navbar-light bg-light ps-2" aria-label="Menu bar"
         *ngIf="guidingStep !== 'home' && guidingStep !== 'create-terminology-resources'">

      <div class="btn-group-sm me-2" role="group" aria-label="Export/Import form from server">
        <button class="btn btn-secondary me-2 menuButton"
                matTooltip="Save"
                (click)="save()" [disabled]="isReadOnly ||!questionnaire "
        >
          <mat-icon class="menuIcon">cloud_upload</mat-icon>
        </button>

        <button type="button" class="btn btn-secondary me-2 menuButton" matTooltip="Load"
                (click)="importFromFHIRServer()">
          <mat-icon class="menuIcon">cloud_download</mat-icon>
        </button>
      </div>

      <div class="btn-group-sm me-2" role="group" aria-label="Edit form attributes">
        <button type="button" class="btn btn-secondary"
                (click)="setStep('fl-editor')" [attr.disabled]="guidingStep === 'fl-editor' ? '' : null">Edit form
          attributes
        </button>
      </div>
      <div class="btn-group-sm me-2" role="group" aria-label="Edit questions">
        <button type="button" class="btn btn-secondary me-2"
                (click)="setStep('item-editor')" [attr.disabled]="guidingStep === 'item-editor' ? '' : null">Edit
          questions
        </button>
      </div>

      <div class="btn-group-sm me-2" role="group" aria-label="Edit questions" *ngIf="isAdmin">
        <button type="button" class="btn btn-secondary" (click)="setStep('create-terminology-resources')">Terminological
          resources
        </button>
      </div>

      <div class="btn-group-sm me-2 ms-auto" role="group" aria-label="Advanced options">
        <button type="button" class="btn btn-secondary menuButton" matTooltip="Advanced options" [matMenuTriggerFor]="advancedMenu">
          <mat-icon class="menuIcon">more_horiz</mat-icon>
        </button>
      </div>

      <div class="btn-group-sm me-2" role="group" aria-label="Preview">
        <button id='previewBtn' type="button" class="btn btn-secondary menuButton" matTooltip="Preview"
                (click)="showPreviewDlg()">
          <mat-icon class="menuIcon">pageview</mat-icon>
        </button>
      </div>
      <div class="btn-group-sm me-2" role="group" aria-label="Help" aria-label="Help">
        <button type="button" matTooltip="Help" class="btn btn-secondary menuButton" (click)="goToHelp()">
          <mat-icon class="menuIcon">help</mat-icon>
        </button>
      </div>
      <div class="btn-group-sm me-2" role="group" aria-label="Close editor">
        <button id="closeBtn" type="button" matTooltip="Close" class="btn btn-secondary menuButton" (click)="close()">
          <mat-icon class="menuIcon">close</mat-icon>
        </button>
      </div>

    </nav>
    <a target="_self" id="exportAnchor" class="d-none">Export</a>
    <input #fileInput class="d-none" type="file" (change)="onFileSelected($event)" (click)="fileInput.value = null;">
    <div class="card bg-danger-subtle m-auto w-75" *ngIf="lformsErrorMessage">
      <div class="card-header d-flex justify-content-center"><h6 class="card-title">Error</h6></div>
      <div class="card-body">{{ lformsErrorMessage }}</div>
    </div>
    <ng-container *ngIf="guidingStep === 'home'">
      <ng-container *ngTemplateOutlet="home"></ng-container>
    </ng-container>
    <ng-container *ngIf="guidingStep === 'fl-editor'">
      <ng-container *ngTemplateOutlet="formLevelFields"></ng-container>
    </ng-container>
    <ng-container *ngIf="guidingStep === 'item-editor'">
      <ng-container *ngTemplateOutlet="itemLevelFields"></ng-container>
    </ng-container>
    <ng-container *ngIf="guidingStep === 'create-terminology-resources'">
      <ng-container *ngTemplateOutlet="createTerminologyResources"></ng-container>
    </ng-container>
  </div>
  <lfb-footer id="fixedBottom"></lfb-footer>
</div>


<mat-menu #advancedMenu="matMenu">
  <button mat-menu-item (click)="onDuplicate()">
    <mat-icon>content_copy</mat-icon>
    <span>Duplicate the current form</span>
  </button>
  <button mat-menu-item (click)="fileInput.click()">
    <mat-icon>save_alt</mat-icon>
    <span>Import a form from local JSON file</span>
  </button>
  <button mat-menu-item (click)="saveToFile()">
    <mat-icon>save</mat-icon>
    <span>Export JSON file of the current form</span>
  </button>
  <button mat-menu-item (click)="validateQuestionnaire()">
    <mat-icon class="menuIcon">verified_user</mat-icon>
    <span>Validation (beta)</span>
  </button>
</mat-menu>

<ng-template #home>
  <div class="card border-0 container">
    <div class="card-body">
      <lfb-fhir-search-page [hasResumeFormOption]="isAutoSaved() && !isDefaultForm()"
      (selectedQuestionnaire)="onQuestionnaireSelected($event)"
      (resumeTheLastForm)="onResumeTheLastForm()"
      (importFromLocalFile)="onImportQuestionnaireFromLocalFile()"></lfb-fhir-search-page>
    </div>
  </div>

  <button
    type="button"
    class="btn btn-primary rounded-circle d-flex justify-content-center align-items-center fab-center shadow"
    (click)="createQuestionnaireFromScratch()"
  >
    +
  </button>

</ng-template>

<ng-template #createTerminologyResources>
  <create-terminology-resources questionnaire="{{questionnaire}}"></create-terminology-resources>
</ng-template>

<ng-template #formLevelFields>
  <lfb-form-fields (state)="setStep($event)"
                   [questionnaire]="formFields"
                   (questionnaireChange)="formFieldsChanged($event)"
                   [questionsButtonLabel]="createButtonLabel()"
  ></lfb-form-fields>
</ng-template>

<ng-template #itemLevelFields>
  <button type="button"
          class="ms-2 fw-bold btn btn-link"
          (click)="setStep('fl-editor')"
  >{{ questionnaire.title }}
  </button>
  <app-alert></app-alert>
  <lfb-item-component [questionnaire]="questionnaire"
                      (itemChange)="itemComponentChanged($event)"
  ></lfb-item-component>
</ng-template>

<ng-template #warnFormLoading let-modal>
  <div role="dialog" aria-labelledby="warningDlgTitle" class="modal-header bg-primary">
    <h4 id="warningDlgTitle" class="modal-title text-white">Replace existing form?</h4>
    <button type="button" class="btn-close btn-close-white" aria-label="Close" (click)="modal.dismiss()">
    </button>
  </div>
  <div class="modal-body">
    This will overwrite the content currently in the form builder. If you wish to save the form currently in the form
    builder, select Cancel. Otherwise, select Continue to overwrite the current form.
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-primary" (click)="modal.close(true)">Continue</button>
    <button type="button" class="btn btn-primary" (click)="modal.dismiss()">Cancel</button>
  </div>
</ng-template>

<ng-template #duplicateEntryDetectedForm let-modal>
  <div role="dialog" aria-labelledby="warningDlgTitle" class="modal-header bg-danger">
    <h4 id="warningDlgTitle" class="modal-title text-white">Duplicate Entry Detected</h4>
    <button type="button" class="btn-close btn-close-white" aria-label="Close" (click)="modal.dismiss()">
    </button>
  </div>
  <div class="modal-body">
    A questionnaire with the same URL and version already exists on the server. Please update the URL or version before saving.
  </div>
</ng-template>



