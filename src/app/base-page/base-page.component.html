<div *ngIf="openerUrl" class="bg-warning-subtle border border-black text-center">Notice: This page is sending changes
  back to the page that opened it, <span class="text-primary">{{ openerUrl }}</span></div>
<div class="page-defaults container-fluid bg-white shadow">
  <lfb-header id="fixedTop"></lfb-header>
  <div id="resizableMiddle">
    <nav class="navbar navbar-light bg-light ps-2" aria-label="Menu bar"
         *ngIf="guidingStep !== 'home' && guidingStep !== 'create-terminology-resources'">

      <div class="btn-group-sm me-2" role="group" aria-label="Export">
        <button class="btn btn-secondary me-2 menuButton" (click)="saveToFile()"
                matTooltip="Export questionnaire JSON file">
          <mat-icon class="menuIcon">save</mat-icon>
        </button>
        <button [disabled]="isReadOnly" class="btn btn-secondary me-2 menuButton" (click)="exportToServer('CREATE')"
                matTooltip="Create questionnaire on the server">
          <mat-icon class="menuIcon">call_split</mat-icon>
        </button>
        <button class="btn btn-secondary me-2 menuButton" matTooltip="Update current questionnaire on the server"
                (click)="exportToServer('UPDATE')" [disabled]="isReadOnly ||!questionnaire || !questionnaire.id"
        >
          <mat-icon class="menuIcon">cloud_upload</mat-icon>
        </button>
      </div>
      <div class="btn-group-sm me-2 " role="group" aria-label="Import">
        <button type="button" class="btn btn-secondary me-2 menuButton" (click)="fileInput.click()"
                matTooltip="Import questionnaire JSON file">
          <mat-icon svgIcon="import-file" class="menuIcon">save_alt</mat-icon>
        </button>
        <button type="button" class="btn btn-secondary me-2 menuButton" matTooltip="Import questionnaire from server"
                (click)="importFromFHIRServer()">
          <mat-icon class="menuIcon">cloud_download</mat-icon>
        </button>
      </div>

      <div class="btn-group-sm me-2" role="group" aria-label="Edit form attributes">
        <button type="button" class="btn btn-secondary"
                (click)="setStep('fl-editor')" [attr.disabled]="guidingStep === 'fl-editor' ? '' : null">Edit form
          attributes
        </button>
      </div>
      <div class="btn-group-sm me-2" role="group" aria-label="Edit questions">
        <button type="button" class="btn btn-secondary me-2"
                (click)="setStep('item-editor')" [attr.disabled]="guidingStep === 'item-editor' ? '' : null">Edit
          questions
        </button>
      </div>
      <div class="btn-group-sm me-2" role="group" aria-label="Edit questions" *ngIf="isAdmin">
        <button type="button" class="btn btn-secondary" (click)="setStep('create-terminology-resources')">Terminological
          resources
        </button>
      </div>

      <div class="btn-group-sm me-2 ms-auto" role="group" aria-label="Preview">
        <button type="button" class="btn btn-secondary menuButton" matTooltip="Validate questionnaire"
                (click)="validateQuestionnaire()">
          <mat-icon class="menuIcon">verified_user</mat-icon>
        </button>
      </div>

      <div class="btn-group-sm me-2" role="group" aria-label="Preview">
        <button id='previewBtn' type="button" class="btn btn-secondary menuButton" matTooltip="Preview"
                (click)="showPreviewDlg()">
          <mat-icon class="menuIcon">pageview</mat-icon>
        </button>
      </div>
      <!--
              <div class="btn-group-sm me-2" role="group" aria-label="Report">
                <button type="button" class="btn btn-secondary menuButton" matTooltip="Report an issue"
                        (click)="reportBug()">
                  <mat-icon class="menuIcon">bug_report</mat-icon>
                </button>
              </div>-->
      <div class="btn-group-sm me-2" role="group" aria-label="Help" aria-label="Help">
        <button type="button" matTooltip="Help" class="btn btn-secondary menuButton" (click)="goToHelp()">
          <mat-icon class="menuIcon">help</mat-icon>
        </button>
      </div>
      <div class="btn-group-sm me-2" role="group" aria-label="Close editor">
        <button id="closeBtn" type="button" matTooltip="Close" class="btn btn-secondary menuButton" (click)="close()">
          <mat-icon class="menuIcon">close</mat-icon>
        </button>
      </div>

    </nav>
    <a target="_self" id="exportAnchor" class="d-none">Export</a>
    <input #fileInput class="d-none" type="file" (change)="onFileSelected($event)" (click)="fileInput.value = null;">
    <div class="card bg-danger-subtle m-auto w-75" *ngIf="lformsErrorMessage">
      <div class="card-header d-flex justify-content-center"><h6 class="card-title">Error</h6></div>
      <div class="card-body">{{ lformsErrorMessage }}</div>
    </div>
    <ng-container *ngIf="guidingStep === 'home'">
      <ng-container *ngTemplateOutlet="home"></ng-container>
    </ng-container>
    <ng-container *ngIf="guidingStep === 'fl-editor'">
      <ng-container *ngTemplateOutlet="formLevelFields"></ng-container>
    </ng-container>
    <ng-container *ngIf="guidingStep === 'item-editor'">
      <ng-container *ngTemplateOutlet="itemLevelFields"></ng-container>
    </ng-container>
    <ng-container *ngIf="guidingStep === 'create-terminology-resources'">
      <ng-container *ngTemplateOutlet="createTerminologyResources"></ng-container>
    </ng-container>
  </div>
  <lfb-footer id="fixedBottom"></lfb-footer>
</div>

<ng-template #home>
  <div class="card border-0 container">
    <div class="card-body">
      <p class="lead" id="starting_header">How do you want to create your form?</p>
      <ul class="list-unstyled ms-5" role="radiogroup" aria-labelledby="starting_header">
        <li>
          <label class="btn">
            <input type="radio" name="startOption" value="fhirServer"
                   [(ngModel)]="startOption" [ngModelOptions]="{standalone: true}">
            Import from FHIR server
          </label>
        </li>
        <li *ngIf="isAutoSaved() && !isDefaultForm()">
          <label class="btn">
            <input type="radio" name="startOption" value="from_autosave"
                   [(ngModel)]="startOption" [ngModelOptions]="{standalone: true}">
            Would you like to start from where you left off before (resume the last form)?
          </label>
        </li>
        <li>
          <label class="btn">
            <input type="radio" name="startOption" value="local"
                   [(ngModel)]="startOption" [ngModelOptions]="{standalone: true}">
            Import from local file
          </label>
        </li>
        <li>
          <label class="btn">
            <input type="radio" name="startOption" value="scratch"
                   [(ngModel)]="startOption" [ngModelOptions]="{standalone: true}">
            Start from scratch
          </label>
        </li>
      </ul>
      <hr>
      <div class="btn-toolbar float-end mb-2" role="toolbar" aria-label="Toolbar with button groups">
        <div class="btn-group" role="group" aria-label="Last group">
          <button type="button" class="btn btn-sm btn-primary" (click)="onContinue()">Continue</button>
        </div>
      </div>
    </div>
  </div>
</ng-template>

<ng-template #createTerminologyResources>
  <create-terminology-resources questionnaire="{{questionnaire}}"></create-terminology-resources>
</ng-template>

<ng-template #formLevelFields>
  <lfb-form-fields (state)="setStep($event)"
                   [questionnaire]="formFields"
                   (questionnaireChange)="formFieldsChanged($event)"
                   [questionsButtonLabel]="createButtonLabel()"
  ></lfb-form-fields>
</ng-template>

<ng-template #itemLevelFields>
  <button type="button"
          class="ms-2 fw-bold btn btn-link"
          (click)="setStep('fl-editor')"
  >{{ questionnaire.title }}
  </button>
  <app-alert></app-alert>
  <lfb-item-component [questionnaire]="questionnaire"
                      (itemChange)="itemComponentChanged($event)"
  ></lfb-item-component>
</ng-template>
<ng-template #loincSearchDlg let-modal>
  <div class="modal-header btn-primary">
    <h4 class="modal-title" id="loinc-search-dlg-title">Import a LOINC Form</h4>
    <button type="button" class="btn-close btn-close-white" aria-label="Close" (click)="modal.dismiss()">
    </button>
  </div>
  <div class="modal-body">
    <form class="px-4 py-3">
      <label for="loincSearch"><span class="p-1">Search LOINC form:</span></label>
      <input type="text"
             id="loincSearch"
             placeholder="Search LOINC forms"
             [ngbTypeahead]="acSearch"
             (selectItem)="modal.close($event.item.id)"
             [resultFormatter]="formatter"
             [inputFormatter]="formatter"
             [editable]='false'/>
    </form>
  </div>
</ng-template>

<ng-template #warnFormLoading let-modal>
  <div role="dialog" aria-labelledby="warningDlgTitle" class="modal-header bg-primary">
    <h4 id="warningDlgTitle" class="modal-title text-white">Replace existing form?</h4>
    <button type="button" class="btn-close btn-close-white" aria-label="Close" (click)="modal.dismiss()">
    </button>
  </div>
  <div class="modal-body">
    This will overwrite the content currently in the form builder. If you wish to save the form currently in the form
    builder, select Cancel. Otherwise, select Continue to overwrite the current form.
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-primary" (click)="modal.close(true)">Continue</button>
    <button type="button" class="btn btn-primary" (click)="modal.dismiss()">Cancel</button>
  </div>
</ng-template>

